name: Deploy Frontend

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 65.109.168.192
          username: work
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e  # Exit on error

            # Navigate to frontend directory
            FRONTEND_DIR=~/website/flashcard-frontend
            if [ ! -d "$FRONTEND_DIR" ]; then
              echo "Error: Frontend directory not found at $FRONTEND_DIR"
              exit 1
            fi

            cd "$FRONTEND_DIR"

            # Save .env file if it exists (shouldn't be in git)
            if [ -f "$FRONTEND_DIR/.env" ]; then
              cp "$FRONTEND_DIR/.env" "$FRONTEND_DIR/.env.backup"
            fi

            # Fetch latest changes and reset to match remote exactly
            # This discards any local changes to match the repository
            git fetch origin
            git reset --hard origin/main || git reset --hard origin/master

            # Restore .env file if it was backed up
            if [ -f "$FRONTEND_DIR/.env.backup" ]; then
              mv "$FRONTEND_DIR/.env.backup" "$FRONTEND_DIR/.env"
            fi

            # Navigate to backend directory (where docker-compose.yml is located)
            BACKEND_DIR=~/website/flashcard-backend
            if [ ! -d "$BACKEND_DIR" ]; then
              echo "Error: Backend directory not found at $BACKEND_DIR"
              exit 1
            fi

            cd "$BACKEND_DIR"

            # Ensure Docker network exists
            docker network create web 2>/dev/null || true

            # Ensure .env file exists in frontend directory (for build args)
            if [ ! -f "$FRONTEND_DIR/.env" ]; then
              echo "Warning: .env file not found in frontend directory"
              echo "Build will use default values from docker-compose.yml"
            fi

            # Rebuild frontend service with build args
            docker compose build --no-cache frontend

            # Stop old container and start new one
            docker compose up -d --force-recreate frontend

            # Verify container is running
            docker compose ps frontend

            # Show logs if there are any issues
            docker compose logs --tail=20 frontend

            echo "Frontend deployment completed successfully!"
